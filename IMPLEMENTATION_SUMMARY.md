# Attendance CSV Import - Implementation Summary

## Problem Statement

The user requested a way to import attendance data from CSV files generated by a barcode scanning system. Members scan their ID cards when arriving at church, which creates a CSV file with Member ID, Date, and Time. They needed:

1. Ability to import this CSV data into ChurchCRM
2. Associate attendance records with individual persons
3. View attendance history for each person

## Solution Implemented

### 1. **AttendanceService** (`src/ChurchCRM/Service/AttendanceService.php`)

A new service class that handles all attendance-related business logic:

**Key Methods:**
- `importAttendanceRecords(array $csvData, int $eventId)` - Imports attendance records from CSV data
- `getPersonAttendance(int $personId, ?string $startDate, ?string $endDate)` - Retrieves attendance history
- `getPersonAttendanceCount(int $personId, ?int $eventId)` - Gets attendance count
- `getOrCreateRecurringEvent(string $eventTitle, int $eventTypeId)` - Manages recurring events

**Features:**
- Validates person IDs against database
- Parses multiple date/time formats
- Prevents duplicate attendance records
- Provides detailed error reporting
- Logs all import operations

### 2. **Attendance CSV Import Page** (`src/AttendanceCSVImport.php`)

A dedicated page for importing attendance data with a user-friendly interface:

**Workflow:**
1. **Upload CSV File** - User selects and uploads their CSV file
2. **Preview & Map Columns** - Shows first 8 rows and allows column mapping
3. **Select/Create Event** - Associate attendance with existing or new event
4. **Import** - Processes the data and shows results

**Features:**
- Auto-detects CSV column types (Person ID, Date, Time, DateTime)
- Supports both separate date/time columns and combined datetime
- Option to ignore header row
- Create new recurring events (Sunday Service, Fellowship Group, etc.)
- Comprehensive error reporting with row-by-row details

### 3. **Person Attendance View** (Modified `src/PersonView.php`)

Added an "Attendance" tab to the person profile page:

**Display:**
- New tab in person profile with attendance icon
- DataTable showing all attendance records
- Columns: Event Name, Check-in Date/Time, Check-out Date/Time
- Links to event details
- Sortable and searchable table

### 4. **Menu Integration** (Modified `src/ChurchCRM/Config/Menu/Menu.php`)

Added menu item:
- **Admin → Attendance CSV Import**
- Uses `fa-clipboard-check` icon
- Admin-only access

### 5. **Testing** (`cypress/e2e/ui/attendance/attendance-import.spec.js`)

Comprehensive Cypress test suite covering:
- Page display and UI elements
- CSV file upload
- Column mapping interface
- Event selection
- Person attendance tab display
- Attendance history display

### 6. **Documentation** (`ATTENDANCE_IMPORT.md`)

Complete user guide including:
- CSV file format examples
- Step-by-step usage instructions
- Best practices
- Troubleshooting guide
- API integration details

## Database Schema

Uses existing `event_attend` table:
```sql
event_attend (
  attend_id INT PRIMARY KEY AUTO_INCREMENT,
  event_id INT NOT NULL,
  person_id INT NOT NULL,
  checkin_date TIMESTAMP,
  checkout_date TIMESTAMP NULL
)
```

## CSV Format Supported

### Option 1: Separate Date and Time
```csv
PersonID,Date,Time
123,2024-01-15,09:30:00
124,2024-01-15,09:35:00
```

### Option 2: Combined DateTime
```csv
PersonID,DateTime
123,2024-01-15 09:30:00
124,2024-01-15 09:35:00
```

## Key Features

✅ **Flexible CSV Format** - Supports multiple column layouts  
✅ **Auto-Detection** - Intelligently detects column types  
✅ **Event Management** - Create or reuse events  
✅ **Validation** - Validates person IDs and date formats  
✅ **Duplicate Prevention** - Prevents duplicate attendance records  
✅ **Error Reporting** - Detailed row-by-row error messages  
✅ **Person Integration** - Attendance tab on person profiles  
✅ **DataTable Display** - Sortable, searchable attendance history  
✅ **Logging** - All operations logged for audit trail  

## Files Created/Modified

### New Files:
- `src/AttendanceCSVImport.php` - Import page
- `src/ChurchCRM/Service/AttendanceService.php` - Business logic
- `cypress/e2e/ui/attendance/attendance-import.spec.js` - Tests
- `ATTENDANCE_IMPORT.md` - Documentation

### Modified Files:
- `src/PersonView.php` - Added Attendance tab
- `src/ChurchCRM/Config/Menu/Menu.php` - Added menu item

## Usage Example

1. **Prepare CSV File:**
   ```csv
   PersonID,Date,Time
   1,2024-02-01,09:00:00
   2,2024-02-01,09:05:00
   3,2024-02-01,09:10:00
   ```

2. **Navigate to Import:**
   Admin → Attendance CSV Import

3. **Upload & Map:**
   - Upload CSV file
   - Verify column mapping (auto-detected)
   - Check "Ignore first CSV row"

4. **Select Event:**
   - Choose "Sunday Service (New)" to create a recurring event
   - Or select an existing event

5. **Import:**
   - Click "Import Attendance Data"
   - Review results (3 imported, 0 skipped)

6. **View Attendance:**
   - Go to any person's profile
   - Click "Attendance" tab
   - See their attendance history

## Benefits

✅ **Solves Original Problem** - Imports barcode scanning data  
✅ **User-Friendly** - Simple upload and map interface  
✅ **Flexible** - Works with various CSV formats  
✅ **Robust** - Validation and error handling  
✅ **Integrated** - Attendance visible on person profiles  
✅ **Scalable** - Handles large CSV files efficiently  
✅ **Documented** - Complete user guide included  
✅ **Tested** - Cypress tests ensure reliability  

## Future Enhancements (Potential)

- Export attendance data to CSV
- Attendance reports and statistics
- Bulk attendance entry via UI
- Integration with check-in kiosks
- Attendance notifications/reminders
- Attendance percentage tracking
