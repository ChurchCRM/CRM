# AI Agent Preferences - ChurchCRM Development
# Used by: Claude, GitHub Copilot, and other AI coding agents
# Last Updated: 2025-11-01
# Location: .github/ai-preferences/preferences.yml

## HOW TO USE THIS FILE
## =====================
## GitHub Copilot: 
##   - Add this file path to Copilot's workspace settings
##   - In VS Code: Cmd/Ctrl + Shift + P > "Copilot: Set Custom Instructions"
##   - Paste content or reference file path
##
## Claude (via Cursor/other IDEs):
##   - Add as a context file or system prompt
##   - Reference in all new conversations
##
## Repository Documentation:
##   - Link this file in CONTRIBUTING.md
##   - Reference in GitHub issue/PR templates
##   - Include in onboarding docs for new contributors

---
## ENFORCEMENT CHECKLIST
enforcement:
  every_commit:
    - "validate_commit_message_format"
    - "check_no_raw_sql"
    - "verify_propel_orm_used"
    - "ensure_systemurls_for_assets"
    - "validate_php82_compatibility"  # Check for deprecated PHP 8.1 patterns
    - "explicit_nullable_syntax"      # Ensure ?type notation for nullable params
  every_pr:
    - "review_communication_style"
    - "verify_service_classes_used"
    - "check_bootstrap_css_applied"
    - "validate_test_impact_documented"
    - "confirm_php82_standards"       # Review for PHP 8.2+ compliance
  setup_required:
    - "add_pr_template: .github/pull_request_template.md"
    - "add_issue_template: .github/ISSUE_TEMPLATE/"

## Communication & Output Style
communication:
  approach: "direct_action_first"
  avoid:
    - "filler_acknowledgements"  # Skip "Sounds good", "Okay, I will..."
    - "repetitive_summaries"     # No recap unless requested
    - "verbose_explanations"     # Only when explicitly asked
  response_format: "action_then_context"
  max_preamble_lines: 1
  output_display:
    - "display_directly_in_chat"  # Show output in chat window, not via echo/cat commands
    - "no_terminal_for_summaries" # Don't use terminal commands to display summaries
    - "use_markdown_formatting"   # Format output with markdown in chat responses


## Commit & PR Standards
commits:
  message_format: "imperative"
  first_line_max: 72
  style: "concise"
  output_format: "markdown"  # Always format commit messages in markdown for easy copy/paste to GitHub
  examples:
    - "Fix SQL injection in EditEventAttendees"
    - "Replace deprecated HTML attributes with Bootstrap CSS"
    - "Add missing element ID for test selector"
  avoid:
    - "detailed_file_lists"
    - "file_path_references_in_messages"
    - "links_to_files"

pull_requests:
  summary_max_lines: 10
  focus: "what_changed_and_why"
  output_format: "markdown"  # Always format PR descriptions in markdown for easy copy/paste to GitHub
  include:
    - "brief_problem_statement"
    - "solution_overview"
    - "test_impact"
  skip:
    - "verbose_explanations"
    - "non_critical_details"
  format_requirements:
    - "use_markdown_headers"     # Use ## for sections
    - "use_code_blocks"          # Wrap code in ```language blocks
    - "use_bullet_lists"         # Use - for lists
    - "use_checkboxes"           # Use - [ ] / - [x] for task lists
    - "ready_to_copy_paste"      # Format should be ready for GitHub without modification

## Code Quality Standards
code_style:
  php:
    minimum_version: "8.2.0"  # MANDATORY as of ChurchCRM 6.0.0
    framework: "Propel ORM (mandatory)"
    database: "never_raw_sql"
    patterns:
      - "use Service classes for business logic"
      - "use Query classes for data access"
      - "avoid inline database logic"
    validation:
      - "run_php_lint before_committing"
      - "check syntax on_modified_files"
    php82_requirements:
      - "explicit_nullable_parameters"  # ?int $param = null, not int $param = null
      - "allow_dynamic_properties_attribute"  # #[\AllowDynamicProperties] for classes needing it
      - "intl_date_formatter"  # Use IntlDateFormatter instead of strftime
      - "explicit_global_namespace"  # Use \globalFunction() in namespaced code
      - "correct_version_checks"  # Use version_compare($v, '8.2.0', '<') not '<='
  javascript:
    bundler: "webpack"
    css_location: "bundled_via_webpack"
    avoid:
      - "cdn_links"
      - "external_stylesheets"

## Database & ORM Requirements
database:
  mandatory_orm: "Propel ORM"
  rules:
    - "ALWAYS use ORM Query classes"
    - "NEVER use RunQuery() with string SQL"
    - "NEVER concatenate SQL strings"
    - "Cast dynamic identifiers to (int)"
    - "Use PDO::PARAM_* for bindings"
  service_classes:
    - "GroupService"
    - "FinancialService"
    - "SystemService"
    - "TaskService"

## Slim Framework Requirements
slim_framework:
  middleware_order: "critical"
  apps_affected:
    - "src/api/index.php"
    - "src/v2/index.php"
    - "src/kiosk/index.php"
    - "src/setup/index.php"
    - "src/external/index.php"
    - "src/session/index.php"
  correct_order:
    - "$app->addBodyParsingMiddleware();"
    - "$app->addRoutingMiddleware(); // Must be BEFORE add() middleware"
    - "$app->add(VersionMiddleware::class);"
    - "$app->add(AuthMiddleware::class); // If needed"
    - "$app->add(new CorsMiddleware()); // If needed"
  why_order_matters:
    - "addRoutingMiddleware() must run BEFORE add() middleware"
    - "Routing determines which route handler processes the request"
    - "If routing runs after auth, unauthenticated requests hit handlers before auth checks"
  common_mistake:
    wrong: "$app->add(AuthMiddleware); $app->addRoutingMiddleware(); // Wrong order"
    impact: "Auth middleware cannot return 401 before routing fails"
    result: "Unauthenticated requests get 404/500 instead of 401"

## Asset & Path References
assets:
  css_bundling: "webpack_only"
  javascript_bundling: "webpack_only"
  path_function: "SystemURLs::getRootPath()"
  rule: "ALWAYS use SystemURLs::getRootPath() for asset references"
  examples:
    correct: '<link rel="stylesheet" href="<?= SystemURLs::getRootPath() ?>/skin/v2/churchcrm.min.css">'
    wrong: '<link rel="stylesheet" href="/skin/v2/churchcrm.min.css">'

## UI/UX Patterns (AdminLTE 3.2.0 + Bootstrap 4.6.2)
ui_patterns:
  card_headers:
    pattern: "Colored outlines with descriptive icons for visual hierarchy"
    classes: "card-{color}-outline"
    colors:
      - "card-info-outline: Information/details sections"
      - "card-primary-outline: Primary content/settings"
      - "card-success-outline: Success states/active content"
      - "card-warning-outline: Warnings/attention needed"
      - "card-danger-outline: Danger/delete actions"
    example: |
      <div class="card card-primary card-outline">
          <div class="card-header">
              <h3 class="card-title"><i class="fa-solid fa-list-check"></i> <?= gettext('Section Title') ?></h3>
          </div>
          <div class="card-body">
              <!-- Content -->
          </div>
      </div>
    avoid: "Generic cards without color or context"

  action_buttons:
    pattern: "btn-app buttons matching PeopleDashboard style"
    required_classes: "btn btn-app bg-{color}"
    icon_size: "fa-3x"
    layout: "Icon on top, text below with <br> separator"
    example: |
      <a class="btn btn-app bg-info" href="Editor.php?ID=<?= $id ?>">
          <i class="fa-solid fa-pen fa-3x"></i><br>
          <?= gettext('Edit') ?>
      </a>
    colors:
      - "bg-info: Edit/modify actions"
      - "bg-danger: Delete/remove actions"
      - "bg-success: Add/create actions"
      - "bg-primary: View/navigate actions"
      - "bg-teal: Email actions"
      - "bg-navy: BCC email actions"
      - "bg-orange: Text/SMS actions"
      - "bg-purple: Special properties/forms"
    avoid: "Small icons without bg- color classes"

  responsive_tables:
    wrapper: "Always wrap tables in div.table-responsive"
    classes: "table table-striped table-hover table-sm"
    example: |
      <div class="table-responsive">
          <table class="table table-striped table-hover table-sm" id="myTable">
          </table>
      </div>
    dataTables_config:
      responsive: true
      autoWidth: false
      column_widths: "Define specific percentages for better control"
      thumbnail_max_size: "Math.min(window.CRM.iProfilePictureListSize, 40)"
    text_truncation: |
      // For long content (addresses, emails)
      return '<span class="d-inline-block text-truncate" 
              style="max-width: 200px;" 
              title="' + fullText + '">' + fullText + '</span>';
    avoid: "Tables without responsive wrapper or defined column widths"

  responsive_layout:
    toggle_controls:
      grid: "col-lg-6 col-md-12 mb-3"
      size: "data-size='normal' (not 'small')"
      reason: "Prevents text cutoff and accommodates localization"
      example: |
        <div class="row mb-3">
            <div class="col-lg-6 col-md-12 mb-3">
                <b><?= gettext('Status') ?>:</b><br>
                <input data-size="normal" id="toggle1" type="checkbox" data-toggle="toggle">
            </div>
        </div>
    info_boxes:
      usage: "Display key stats/metrics"
      classes: "info-box bg-{color}"
      example: |
        <div class="info-box bg-success">
            <span class="info-box-icon"><i class="fa-solid fa-layer-group"></i></span>
            <div class="info-box-content">
                <span class="info-box-text"><?= gettext('Label') ?></span>
                <span class="info-box-number"><?= $value ?></span>
            </div>
        </div>
    avoid: "Fixed col-sm-* classes that break on mobile"

  conditional_rendering:
    pattern: "Build data list first, then conditionally render UI"
    reason: "Prevents empty dropdowns and reduces UI clutter"
    example: |
      // Build list first
      $availableItems = [];
      while ($row = mysqli_fetch_array($result)) {
          extract($row);
          $availableItems[] = ['id' => $id, 'name' => $name];
      }
      
      // Only show if data exists
      if (!empty($availableItems)) {
          echo '<form>...</form>';
      }
    avoid: "Always showing UI elements that may be empty"

  layout_organization:
    principle: "Logical grouping with clear visual hierarchy"
    pattern: "Info boxes first, then action buttons, then detailed content"
    example: |
      <div class="row mt-3">
          <div class="col-md-4"><!-- Info box 1 --></div>
          <div class="col-md-4"><!-- Info box 2 --></div>
          <div class="col-md-4"><!-- Info box 3 --></div>
      </div>
      <div class="row mt-3">
          <div class="col-12">
              <!-- All action buttons together -->
          </div>
      </div>
    avoid: "Mixing buttons with content without clear structure"

## Asset & Path References
  example:
    wrong: "href='/skin/v2/churchcrm.min.css'"
    right: "href='<?= SystemURLs::getRootPath() ?>/skin/v2/churchcrm.min.css'"
  avoid:
    - "relative_paths"
    - "dirname($_SERVER['PHP_SELF'])"
    - "cdn_links"

## HTML & CSS Modernization
html_standards:
  bootstrap_framework: "yes"
  target_standard: "HTML5"

## Testing Requirements
testing:
  automated_checks: "required_when_available"
  pre_test_protocol:
    description: "Ensure clean environment and fresh logs for accurate debugging"
    steps:
      - "Clear logs: rm -f src/logs/$(date +%Y-%m-%d)-*.log"
      - "Verify logs directory is empty before starting tests"
      - "Document any pre-test setup required (DB state, Docker restart, etc)"
    why_important:
      - "Old errors in logs can mask new failures"
      - "Fresh logs make it easier to trace test failures"
      - "Prevents debugging confusion from stale error messages"
  post_test_protocol:
    description: "Review logs to understand test failures"
    steps:
      - "After test failures, immediately review: src/logs/{date}-php.log"
      - "Check for new error messages, not just routing errors"
      - "Look for stack traces that indicate root cause"
      - "Cross-reference with test output for correlation"
    log_locations:
      php_errors: "src/logs/{date}-php.log"
      orm_queries: "src/logs/{date}-orm.log"
      app_events: "src/logs/{date}-app.log"
    best_practices:
      - "Clear logs before EVERY test run to ensure freshness"
      - "Review logs AFTER test failures before iterating"
      - "Document any new errors found in logs"
      - "Distinguish between expected errors (auth tests) and unexpected (500 errors)"
  types:
    ui:
      framework: "Cypress"
      location: "cypress/e2e/ui/**/*.spec.js"
      pattern: "describe/it with proper selectors"
      requirements:
        - "maintain element IDs for test selectors"
        - "use cy.get() for element queries"
        - "test user workflows end-to-end"
      example: "cypress/e2e/ui/events/standard.events.spec.js"
    api:
      framework: "Cypress API requests"
      location: "cypress/e2e/api/**/*.spec.js"
      pattern: "describe/it with cy.makePrivateAdminAPICall or cy.request"
      requirements:
        - "test all HTTP methods (GET, POST, PUT, DELETE)"
        - "verify type safety and data conversion"
        - "test authentication (401/403 responses)"
        - "test validation logic and error handling"
        - "verify null safety for object properties"
        - "test boundary conditions and edge cases"
      directory_structure: "api/[private|public]/[module]/"
      authentication:
        - "use cy.makePrivateAdminAPICall() for admin routes"
        - "use cy.makePrivateUserAPICall() for user routes"
        - "use cy.apiRequest() for public/unauthenticated tests"
      example: "cypress/e2e/api/private/finance/finance-payments.spec.js"
  pre_commit:
    - "verify_no_php_errors"
    - "verify_no_syntax_errors"
    - "run_relevant_api_tests_if_changed"
  output_style: "concise_summary"
  test_failure_response: "fix_or_escalate_clearly"
  api_test_checklist:
    - "type hints match actual usage (array vs object)"
    - "null safety checks on all property accesses"
    - "proper Content-Type headers for JSON requests"
    - "error responses documented and tested"
    - "authentication requirements validated"

  ## API Testing Standards
  api_tests:
    requirement: "mandatory_for_api_changes"
    when_to_write:
      - "any_changes_to_api_routes"
      - "any_changes_to_api_service_methods"
      - "adding_new_api_endpoints"
      - "fixing_api_bugs_or_errors"
    test_location: "cypress/e2e/api/private/[feature]/"
    test_naming: "[service]-[endpoint].spec.js"
    examples:
      - "cypress/e2e/api/private/finance/finance-payments.spec.js"
      - "cypress/e2e/api/private/people/people-import.spec.js"
    structure:
      - "MUST use Cypress helper commands (NEVER use cy.request directly)"
      - "include_valid_payload_tests: successful requests with correct data"
      - "include_validation_tests: test validation rules (e.g., invalid dates, missing fields)"
      - "include_error_tests: test error cases (401 auth, 400 validation, 500 server errors)"
      - "include_type_safety_tests: verify type conversions and casts work correctly"
      - "include_edge_cases: boundary conditions, null values, empty arrays"
    test_categories:
      successful_operations:
        description: "Test successful API calls with valid payloads"
        example: "POST /api/payments - Accepts properly structured payment data"
      validation_tests:
        description: "Test business logic validation (dates, funds, methods)"
        example: "POST /api/payments - Validates check method with check number"
      type_safety:
        description: "Test that type conversions don't cause runtime errors"
        example: "POST /api/payments - Type hint enforcement prevents object access errors"
      error_handling:
        description: "Test error responses (401, 400, 500)"
        example: "POST /api/payments - Requires authentication"
      security:
        description: "Test authentication and authorization"
        example: "Verify unauthenticated requests are rejected"
    cypress_commands:
      admin_api_call: 
        signature: "cy.makePrivateAdminAPICall(method, url, body, expectedStatus)"
        usage: "For admin/protected routes requiring admin API key"
        example: "cy.makePrivateAdminAPICall('POST', '/api/payments', payload, 200)"
      user_api_call: 
        signature: "cy.makePrivateUserAPICall(method, url, body, expectedStatus)"
        usage: "For protected routes requiring regular user API key"
        example: "cy.makePrivateUserAPICall('GET', '/api/payments', null, 200)"
      generic_request: 
        signature: "cy.apiRequest(options)"
        usage: "For unauthenticated/public routes or custom requests"
        example: "cy.apiRequest({method: 'POST', url: '/api/payments', failOnStatusCode: false})"
    content_type:
      requirement: "ALWAYS application/json in header"
      auto_set_by: "cy.makePrivateAdminAPICall and cy.makePrivateUserAPICall"
      manual_header: "Required only if using cy.apiRequest()"
      verification: "PHP methods should receive properly typed data"
    best_practices:
      - "Use cy.makePrivateAdminAPICall() for all admin-required endpoints"
      - "Use cy.makePrivateUserAPICall() for user-facing endpoints"
      - "Use cy.apiRequest() ONLY for public/unauthenticated routes"
      - "Test both success and failure paths"
      - "Verify type casting works (array to object)"
      - "Include null safety checks in API tests"
      - "Test all validation rules documented in the service"
      - "Use descriptive test names that explain what is being tested"
      - "Group related tests in describe blocks"
  
  ui_tests:
    requirement: "mandatory_for_ui_changes"
    when_to_write:
      - "any_visible_ui_changes"
      - "any_html_attribute_changes"
      - "adding_new_form_fields"
      - "changing_element_selectors_or_ids"
    test_location: "cypress/e2e/ui/[feature]/"
    tools:
      - "Cypress for UI automation"
      - "CSS selectors or element IDs"
      - "Data attributes for complex selectors"
  
  unit_tests:
    when_to_write:
      - "complex_business_logic"
      - "service_class_methods"
      - "utility_functions"
    location: "tests/ directory"
    framework: "phpunit"

## Documentation Standards
documentation:
  policy: "only_when_requested"
  preferences:
    - "inline_code_comments for complex logic"
    - "minimal_readme_updates"
    - "store_project_notes in ai-notes/ only"
  note_guidelines:
    - "keep_minimal: active tasks, completed items, quick patterns"
    - "do_not_create: extensive phase docs or analysis docs"
    - "ask_before_creating: 'Should this be stored?'"
  exclusions:
    - "analysis_docs"
    - "phase_summaries"
    - "extensive_reference_docs"

## Branch Naming
branches:
  format: "type/description"
  types:
    - "feature"
    - "fix"
    - "refactor"
    - "hotfix"
  style: "kebab-case"
  length: "short_but_descriptive"
  examples:
    - "fix/sql-injection-event-id"
    - "refactor/deprecated-html-attributes"
    - "feature/new-event-reporting"

## File Organization
files:
  ai_notes_directory: "ai-notes/"
  ai_notes_scope: "local_development_only"
  ai_notes_gitignore: "true"
  preferences_file: ".github/ai-preferences/preferences.yml"
  temporary_files:
    description: "All temporary .txt and .md files created for user reading"
    location: "ai-notes/"
    examples:
      - "commit-message.txt"
      - "summary.md"
      - "analysis.txt"
      - "notes.md"
    rule: "ALWAYS create temporary documentation files in ai-notes/ directory"
    why: "Keeps workspace clean and separates AI-generated notes from project code"

## Priority Rules
rules_priority:
  - "security_first: always use Propel ORM, never raw SQL"
  - "html5_compliance: replace deprecated attributes with CSS"
  - "service_pattern: use Service classes for business logic"
  - "asset_paths: always use SystemURLs::getRootPath()"
  - "code_quality: validate before committing"
  - "clear_communication: direct, concise, actionable"

## Error Handling
errors:
  policy: "fix_immediately"
  validation:
    - "php_lint_all_modified_php_files"
    - "check_syntax_errors"
    - "test_if_available"
  escalation: "provide_actionable_error_details"

## Review Checklist (Before Commit)
pre_commit_checklist:
  - "PHP syntax validation passed"
  - "Propel ORM used for all database operations"
  - "Asset paths use SystemURLs::getRootPath()"
  - "Service classes used for business logic"
  - "Deprecated HTML attributes replaced with CSS"
  - "Bootstrap CSS classes applied correctly"
  - "Tests pass (if available)"
  - "Commit message follows imperative mood"
  - "Branch name follows kebab-case format"

## Special Instructions
special:
  test_failures:
    approach: "identify_root_cause_then_fix"
    document: "briefly_in_commit_message"
    examples:
      - "Missing element ID for test selector"
      - "Incorrect object validation logic"
      - "Unexpected redirect or page navigation"

## Version Control
git:
  commit_frequency: "atomic_logical_units"
  commit_size: "focused_single_concern"
  avoid: "massive_multi_topic_commits"
  message_detail: "minimal_but_sufficient"

## Case Study: Type Mismatch & Architecture Improvements (Lessons Learned)
## =====================================================
## Context: Identified during API endpoint debugging and architectural review
## Applies To: All similar patterns in codebase
## 
## Key Learnings for Future Work:
critical_patterns:
  type_safety:
    description: "Propel ORM returns objects, never arrays"
    example: "Wrong: $payment['Date'] | Correct: $payment->Date"
    impact: "Type mismatches cause TypeError exceptions -> 500 errors"
    prevention: "Always validate return types from ORM Query classes"
  
  middleware_ordering:
    description: "Slim Framework middleware execution order is critical"
    position: "addRoutingMiddleware() MUST run BEFORE add() middleware calls"
    why: "Routing determines handler execution; if routing runs after auth, unauthenticated requests hit handlers"
    impact: "Wrong order: 401/403 auth responses become 500 errors"
    affected_apps: "All Slim-based applications with middleware stack"
    checklist: "Review middleware order in all index.php files if encountering auth-related 500 errors"
  
  error_handler:
    description: "Error handlers must preserve HTTP status codes"
    issue: "Error handlers forcing 500 status on all exceptions instead of preserving original status"
    fix_pattern: "Check exception type and preserve original HTTP status code"
    impact: "Auth failures now correctly return 401/403 instead of 500"
    checklist:
      - "Review error handler implementation"
      - "Identify if status codes are being overwritten"
      - "Check exception type before applying status"
  
  slim4_route_handlers:
    description: "Slim 4 requires inline closures, not string callables"
    wrong: "$group->post('/path', 'functionName'); function functionName(...) {...}"
    correct: "$group->post('/path', function (...) {...});"
    why: "String callable references don't resolve in Slim 4 routing system"
    impact: "Routes not found or handlers not executed"
    checklist: "Review all route definitions; ensure closures instead of string references"
  
  global_function_namespace:
    description: "Namespaced classes calling global functions need \\ prefix"
    wrong: "namespace ChurchCRM\\...; MakeFYString($id);"
    correct: "namespace ChurchCRM\\...; \\MakeFYString($id);"
    why: "Without \\, PHP searches current namespace first, causing 'undefined function' errors"
    impact: "500 errors on related functionality"
    checklist: "When calling global functions from namespaced code, prefix with \\\\"
  
  email_failure_handling:
    description: "Email sending failures should not crash API endpoints"
    pattern_1: "throw new Exception() on send failure → 500 error in test environment"
    pattern_2: "Log warning + continue → graceful degradation, 200 response"
    decision_criteria:
      - "Pattern 1 for critical operations (required emails)"
      - "Pattern 2 for non-critical operations (notifications, confirmations)"
    testing: "Test API behavior when email service is unavailable"
  
  null_safety:
    description: "Always assume object properties can be null"
    example: "$notification->title ?? 'Notification'"
    impact: "Prevents TypeError when accessing undefined/null properties"
    file: "src/api/routes/system/system.php"
  
  property_access_type_mismatch:
    description: "API parsers cast body to objects; validation methods must use object syntax, not array syntax"
    pattern: "Mismatch between parser output type and property access syntax"
    wrong_example: "$data['property'] when parser returns object"
    correct_example: "$data->property when parser returns object"
    impact: "Type mismatches cause TypeError exceptions → 500 errors on API calls"
    prevention_checklist:
      - "Identify parser output type (array vs object vs typed class)"
      - "Use consistent property access syntax matching parser output"
      - "Validate return types from all data sources (ORM, parsers, services)"
      - "Add type hints to catch mismatches at compile time"
    testing_approach: "Create type safety tests validating data access patterns work correctly"
  
  global_to_service_migration:
    description: "Migrate global functions to service class static methods for better organization"
    pattern: "Consolidate related global functions into logical service classes"
    wrong_pattern: "Global function calls scattered across codebase"
    correct_pattern: "ServiceClass::staticMethod() with organized, namespaced code"
    benefits:
      - "Better code organization and discoverability"
      - "Type safety with type hints"
      - "Easier to test and mock"
      - "Clearer dependency flow"
    migration_steps:
      - "Identify related global functions by domain"
      - "Create or identify appropriate service class"
      - "Convert to static methods in service class"
      - "Update all call sites to use new pattern"
      - "Test after each conversion to catch regressions"

testing_standards_established:
  api_tests_mandatory:
    description: "Create Cypress API tests for all API changes"
    location: "cypress/e2e/api/private/[module]/[service]-[endpoint].spec.js"
    coverage: "Type safety, null safety, validation, error handling, authentication"
  
  test_isolation:
    description: "Log directory must be clean before tests"
    why: "Old errors in logs mask new failures"
    command: "rm -f src/logs/$(date +%Y-%m-%d)-*.log"
  
  cypress_helpers:
    description: "Use provided helper commands, never raw cy.request()"
    admin: "cy.makePrivateAdminAPICall(method, url, body, expectedStatus)"
    user: "cy.makePrivateUserAPICall(method, url, body, expectedStatus)"
    public: "cy.apiRequest(options) for unauthenticated routes"
    why: "Helpers auto-set Content-Type: application/json header"

performance_checklist:
  api_response_times:
    validate: "API responses complete in reasonable time (<1s typically)"
    investigate_if: "Tests timeout or take abnormally long"
    common_causes:
      - "Undefined function errors causing 500 responses"
      - "Infinite loops or missing early returns"
      - "Database queries without proper indexing"
  
  debugging_approach:
    - "Check API logs for error stack traces"
    - "Verify function calls match current codebase"
    - "Test with fresh database state"
    - "Review middleware and error handling

## PR Organization Strategy

pr_organization:
  philosophy: "Keep PRs focused on single concerns for easier review and merging"
  approach:
    - "Split large changes into logical feature branches"
    - "Each PR addresses one specific bug or feature"
    - "Related but separate concerns get separate branches"
    - "Test each branch independently before PR"
  branch_types:
    feature_branch:
      when: "Adding new functionality or fixing bugs in related domain"
      characteristics: "Multiple files, cohesive business logic"
      testing: "Full test suite for feature"
    
    fix_branch:
      when: "Fixing isolated bugs separate from other concerns"
      characteristics: "Minimal files, single issue focused"
      testing: "Tests specifically validating the fix"
  
  multiple_concerns_pattern:
    recognize_when:
      - "PR includes unrelated bug fixes"
      - "Separate features mixed into single branch"
      - "Cleanup changes alongside feature work"
    action:
      - "Create separate branches for each concern"
      - "Provide merge order recommendations"
      - "Reference across branches for context"
    benefit: "Cleaner git history, easier to revert if needed, simpler code review"

---
# Last Updated: 2025-10-25
# Applicable To: All AI agents and coding assistants
# Repository: https://github.com/ChurchCRM/CRM
