name: Locale Term Extraction

on:
  push:
    branches:
      - master
    paths:
      - 'src/**/*.php'
      - 'src/**/*.js'
      - 'src/**/*.jsx'
      - 'src/**/*.ts'
      - 'src/**/*.tsx'
      - 'react/**/*.jsx'
      - 'react/**/*.tsx'
  workflow_dispatch:
    # Allow manual triggering from GitHub UI
    inputs:
      force_pr:
        description: 'Force create PR even if only date changed'
        required: false
        type: boolean
        default: false

jobs:
  extract-terms:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['20.x']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # fetch full history so we can detect meaningful changes
        fetch-depth: 0
        # Use token for write access
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Start database early (parallel with setup)
      run: |
        echo "ğŸš€ Starting database early while other setup tasks run..."
        cp docker/Config.php src/Include/Config.php
        docker compose -f docker/docker-compose.test-php8-apache.yaml up -d database
        echo "ğŸ“Š Database container starting in background..."

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: Get package version
      id: package-version
      uses: martinbeentjes/npm-get-version-action@v1.3.1

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install dependencies
      run: npm ci

    - name: Create BuildConfig with Docker database settings
      run: |
        echo "ğŸ”§ Creating BuildConfig.json with Docker database configuration..."
        cp BuildConfig.json.example BuildConfig.json
        
        # Update BuildConfig.json to use Docker database settings
        cat > BuildConfig.json << 'EOF'
        {
            "POEditor": {
                "id": "77079",
                "token": ""
            },
            "GitHub": {
                "token": ""
            },
            "demoKey": "",
            "Env": {
                "local": {
                    "server": "127.0.0.1",
                    "database": {
                        "server": "127.0.0.1",
                        "port": "3306",
                        "database": "churchcrm",
                        "user": "churchcrm",
                        "password": "changeme"
                    },
                    "admin-api-key": ""
                }
            }
        }
        EOF
        echo "âœ… BuildConfig.json created with Docker database configuration"

    - name: Wait for database readiness
      run: |
        echo "â³ Checking database readiness (started earlier)..."
        
        # Wait for database container to be running
        timeout=30
        elapsed=0
        while [ -z "$(docker ps -q --filter 'name=database')" ]; do
          if [ "$elapsed" -ge "$timeout" ]; then
            echo "âŒ Database container not found after $timeout seconds"
            docker ps -a
            exit 1
          fi
          sleep 2
          elapsed=$((elapsed + 2))
        done
        echo "  âœ… Database container is running"
        
        # Wait for MySQL to be ready
        echo "  Waiting for MySQL to accept connections..."
        timeout=90
        elapsed=0
        
        until docker exec $(docker ps -q --filter "name=database") mysqladmin ping --silent 2>/dev/null; do
          if [ "$elapsed" -ge "$timeout" ]; then
            echo "âŒ MySQL not ready within $timeout seconds"
            echo "Database logs (last 30 lines):"
            docker logs $(docker ps -q --filter "name=database") --tail=30 || true
            exit 1
          fi
          
          # Progressive check intervals
          if [ "$elapsed" -lt 30 ]; then
            sleep 2
            elapsed=$((elapsed + 2))
          else
            sleep 3
            elapsed=$((elapsed + 3))
          fi
          
          # Show progress every 15 seconds
          if [ $((elapsed % 15)) -eq 0 ]; then
            echo "    MySQL initializing... ($elapsed/$timeout seconds)"
          fi
        done
        
        # Quick connection test
        echo "  Testing database connection..."
        docker exec $(docker ps -q --filter "name=database") mysql -u churchcrm -pchangeme -e "SELECT 1;" > /dev/null
        
        echo "âœ… Database ready for term extraction (total wait: ${elapsed}s)"

    - name: Backup original messages.po
      run: cp locale/messages.po locale/messages.po.backup

    - name: Extract locale terms
      run: |
        echo "ğŸ” Extracting locale terms from all sources..."
        echo "ğŸ“Š This includes: database terms, static data, PHP code, and JavaScript/React code"
        npm run locale:term-extract
        echo "âœ… Locale term extraction completed"

    - name: Check for meaningful changes
      id: changes
      run: |
        if [ ! -f "locale/messages.po" ]; then
          echo "âŒ messages.po file not found after extraction"
          exit 1
        fi
        
        # Check if file has any changes at all
        if git diff --quiet locale/messages.po; then
          echo "No changes detected in messages.po"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "meaningful_changes=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "Changes detected in messages.po"
        echo "has_changes=true" >> $GITHUB_OUTPUT
        
        # Check if changes are only in the POT-Creation-Date line
        # Create a temporary file with date normalized for comparison
        sed 's/POT-Creation-Date: [^\\]*/POT-Creation-Date: NORMALIZED/' locale/messages.po.backup > /tmp/messages_orig_normalized.po
        sed 's/POT-Creation-Date: [^\\]*/POT-Creation-Date: NORMALIZED/' locale/messages.po > /tmp/messages_new_normalized.po
        
        if diff -q /tmp/messages_orig_normalized.po /tmp/messages_new_normalized.po > /dev/null; then
          echo "Only date changes detected (POT-Creation-Date)"
          echo "meaningful_changes=false" >> $GITHUB_OUTPUT
          
          # Show what actually changed for logging
          echo "ğŸ” Only POT-Creation-Date changed:"
          git diff locale/messages.po | grep "POT-Creation-Date" || true
        else
          echo "Meaningful changes detected beyond date"
          echo "meaningful_changes=true" >> $GITHUB_OUTPUT
          
          # Show summary of changes
          echo "ğŸ“Š Change summary:"
          echo "Lines added: $(git diff --numstat locale/messages.po | cut -f1)"
          echo "Lines removed: $(git diff --numstat locale/messages.po | cut -f2)"
          
          # Show first few meaningful changes (exclude date lines)
          echo "ğŸ” Sample of meaningful changes:"
          git diff locale/messages.po | grep -E "^[+-]" | grep -v "POT-Creation-Date" | head -10 || true
        fi

    - name: Create Pull Request
      if: steps.changes.outputs.meaningful_changes == 'true' || (steps.changes.outputs.has_changes == 'true' && inputs.force_pr)
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: 'locale/term-extract-${{ steps.date.outputs.date }}'
        delete-branch: true
        labels: |
          localization
          automated
          term-extraction
        title: "ğŸ”¤ Locale Term Extraction - ${{ steps.date.outputs.date }}"
        commit-message: |
          ğŸ”¤ Extract new locale terms from source code
          
          - Updated messages.po with newly discovered translatable strings
          - Extracted from PHP, JS, JSX, TS, TSX files
          - Date: ${{ steps.date.outputs.date }}
          - Triggered: ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'Code changes in master' }}
        body: |
          ## ğŸ”¤ Automatic Locale Term Extraction
          
          This PR contains newly discovered translatable strings extracted from the source code.
          
          **Details:**
          - ğŸ“… **Date**: ${{ steps.date.outputs.date }}
          - ğŸ·ï¸ **Version**: ${{ steps.package-version.outputs.current-version }}
          - ğŸš€ **Trigger**: ${{ github.event_name == 'workflow_dispatch' && 'Manual run' || 'Source code changes detected' }}
          - ğŸ” **Changes**: ${{ steps.changes.outputs.meaningful_changes == 'true' && 'New terms found' || 'Forced PR creation' }}
          
          **What's included:**
          - Updated `locale/messages.po` with new translatable strings
          - Terms extracted from PHP, JavaScript, TypeScript, and React files
          - Ready for translation via POEditor
          
          **Next Steps:**
          1. Review the new strings in `locale/messages.po`
          2. Merge this PR to update the master template
          3. Upload updated template to POEditor for translation
          
          This PR was automatically created by the locale term extraction workflow.
          
          ---
          
          **Manual Run Options:**
          ${{ inputs.force_pr == true && '- ğŸ”„ Forced PR creation (ignoring date-only changes)' || '- ğŸ¯ Standard run (meaningful changes only)' }}

    - name: Report results
      run: |
        echo "## ğŸ“Š Locale Term Extraction Results"
        echo "- **Files checked**: PHP, JS, JSX, TS, TSX files in src/ and react/"
        echo "- **Changes detected**: ${{ steps.changes.outputs.has_changes }}"
        echo "- **Meaningful changes**: ${{ steps.changes.outputs.meaningful_changes }}"
        echo "- **PR created**: ${{ (steps.changes.outputs.meaningful_changes == 'true' || (steps.changes.outputs.has_changes == 'true' && inputs.force_pr)) && 'Yes' || 'No' }}"
        echo "- **Branch**: ${{ (steps.changes.outputs.meaningful_changes == 'true' || (steps.changes.outputs.has_changes == 'true' && inputs.force_pr)) && format('locale/term-extract-{0}', steps.date.outputs.date) || 'None' }}"
        echo "- **Trigger**: ${{ github.event_name }}"
        
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          echo ""
          echo "ğŸ“‹ **Changed Files:**"
          git diff --name-only
          
          if [ "${{ steps.changes.outputs.meaningful_changes }}" == "true" ]; then
            echo ""
            echo "ğŸ” **Change Statistics:**"
            git diff --stat locale/messages.po
          fi
        fi

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up Docker containers and temporary files..."
        # Stop only the database container (since we didn't start webserver)
        docker compose -f docker/docker-compose.test-php8-apache.yaml down -v || true
        
        # Clean up backup file
        rm -f locale/messages.po.backup
        rm -f /tmp/messages_*_normalized.po
        
        echo "âœ… Cleanup completed"