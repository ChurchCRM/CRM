name: Auto-comment on Issues with Diagnostics Links

# Triggers on newly opened issues
on:
  issues:
    types: [opened]

jobs:
  comment-on-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Comment on bug reports
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const workspace = process.env.GITHUB_WORKSPACE || process.cwd();

            // Read template files from the repository (bug, question, generic)
            let bugComment = '';
            let questionComment = '';
            let genericComment = '';
            try {
              bugComment = fs.readFileSync(path.join(workspace, '.github/issue-comments/bug.md'), 'utf8');
            } catch (e) {
              console.log('Could not read bug.md:', e.message);
            }
            try {
              questionComment = fs.readFileSync(path.join(workspace, '.github/issue-comments/question.md'), 'utf8');
            } catch (e) {
              console.log('Could not read question.md:', e.message);
            }
            try {
              genericComment = fs.readFileSync(path.join(workspace, '.github/issue-comments/generic.md'), 'utf8');
            } catch (e) {
              console.log('Could not read generic.md:', e.message);
            }

            const issue = context.payload.issue || {};
            
            // Log the full issue payload for debugging
            console.log('Issue payload keys:', Object.keys(issue));
            console.log('Issue body:', issue.body);
            console.log('Issue labels:', issue.labels);
            
            // GitHub doesn't send 'type' in webhook payload, but we can detect from template used
            // The template name is NOT directly available, so detect by checking issue body prefix or labels
            const body = (issue.body || '').toLowerCase();
            const labels = (issue.labels || []).map(l => (l.name || l).toLowerCase());
            
            // Detect based on: body content pattern, labels, or title prefix
            const isBug = body.includes('describe the issue') || 
                         labels.some(l => l.includes('bug')) ||
                         labels.some(l => l.includes('type:bug'));
            
            const isQuestion = body.includes('how can we help') || 
                              labels.some(l => l.includes('question')) ||
                              labels.some(l => l.includes('type:question'));

            // Choose template based on type detection; fall back to genericComment if no match
            let comment = '';
            console.log('isBug:', isBug, 'isQuestion:', isQuestion);
            if (isBug && bugComment) {
              console.log('Posting bug comment');
              comment = bugComment;
            } else if (isQuestion && questionComment) {
              console.log('Posting question comment');
              comment = questionComment;
            } else if (genericComment) {
              console.log('Posting generic comment');
              comment = genericComment;
            }

            if (comment) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              console.log('No comment template available to post.');
            }
